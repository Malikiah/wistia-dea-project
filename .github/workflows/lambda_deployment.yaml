name: Deploy Wistia Extractor Lambda

on:
  push:
    branches:
      - main

env:
  WISTIA_API_KEY: ${{ secrets.WISTIA_API_KEY }}

  LAMBDA_FUNCTION_NAME: wistia-api-pull
  AWS_REGION: us-east-1
  S3_DEPLOYMENT_BUCKET: wistia-dea-project #
  AWS_ROLE: arn:aws:iam::918346807626:role/github-actions-lambda

  LAMBDA_EXECUTION_ROLE: arn:aws:iam::918346807626:role/service-role/wisita-api-pull-role-ympahjkx
  LAMBDA_HANDLER: lambda_function.lambda_handler
  LAMBDA_RUNTIME: python3.9
  LAMBDA_TIMEOUT: 30
  LAMBDA_MEMORY: 128

  SCHEDULE_CRON: 'cron(0 5 * * ? *)'
  EVENTBRIDGE_RULE_NAME: WistiaPullScheduleRule

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required to request an OIDC token
      contents: read
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{env.AWS_ROLE}}
          aws-region: ${{ env.AWS_REGION }}

      # Setup Python Environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9' # Ensure this matches your Lambda runtime

      - name: Make package script executable
        run: chmod +x .github/scripts/create_package.sh
      - name: Execute packaging script
        run: ./.github/scripts/create_package.sh

      # Upload Package to S3 (Staging)
      - name: Upload deployment package to S3
        run: |
          aws s3 cp wistia_lambda_package.zip s3://${{ env.S3_DEPLOYMENT_BUCKET }}/wistia_lambda_package.zip

      # Deploy to AWS Lambda
      - name: Deploy Lambda function (Using S3 Artifact)
        run: |
          FUNCTION_EXISTS=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} > /dev/null 2>&1 && echo 0 || echo 1)

          # Define the ENVIRONMENT variable parameter string
          ENVIRONMENT_VARS="Variables={WISTIA_API_KEY=${{ env.WISTIA_API_KEY }}}"

          if [ "${FUNCTION_EXISTS}" -eq 0 ]; then
            echo "Function ${{ env.LAMBDA_FUNCTION_NAME }} exists. Running update..."
            
            # --- UPDATE FUNCTION CODE & CONFIGURATION ---
            aws lambda update-function-code \
              --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
              --s3-bucket ${{ env.S3_DEPLOYMENT_BUCKET }} \
              --s3-key wistia_lambda_package.zip \
              --region ${{ env.AWS_REGION }}

            echo "Waiting for code update to complete before modifying configuration..."
            aws lambda wait function-updated \
              --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
              --region ${{ env.AWS_REGION }}

            # Update Configuration (important if runtime, memory, or role changes)
            aws lambda update-function-configuration \
              --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
              --runtime ${{ env.LAMBDA_RUNTIME }} \
              --role ${{ env.LAMBDA_EXECUTION_ROLE }} \
              --handler ${{ env.LAMBDA_HANDLER }} \
              --timeout ${{ env.LAMBDA_TIMEOUT }} \
              --memory-size ${{ env.LAMBDA_MEMORY }} \
              --environment "$ENVIRONMENT_VARS" \
              --region ${{ env.AWS_REGION }}
            
          else
            echo "Function ${{ env.LAMBDA_FUNCTION_NAME }} does not exist. Running create..."
            
            # --- CREATE FUNCTION --
            aws lambda create-function \
              --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
              --runtime ${{ env.LAMBDA_RUNTIME }} \
              --role ${{ env.LAMBDA_EXECUTION_ROLE }} \
              --handler ${{ env.LAMBDA_HANDLER }} \
              --timeout ${{ env.LAMBDA_TIMEOUT }} \
              --memory-size ${{ env.LAMBDA_MEMORY }} \
              --code S3Bucket=${{ env.S3_DEPLOYMENT_BUCKET }},S3Key=wistia_lambda_package.zip \
              --environment "$ENVIRONMENT_VARS" \
              --region ${{ env.AWS_REGION }}
          fi
      # Configure EventBridge Schedule
      - name: Configure daily EventBridge schedule
        run: |
          # Define Statement ID for permission check
          STATEMENT_ID="${{ env.EVENTBRIDGE_RULE_NAME }}-Invoke"

          # Get Lambda ARN (Needed for both targets and permissions)
          LAMBDA_ARN=$(aws lambda get-function \
            --function-name "${{ env.LAMBDA_FUNCTION_NAME }}" \
            --query 'Configuration.FunctionArn' \
            --region "${{ env.AWS_REGION }}" \
            --output text)

          # Get EventBridge Rule ARN (Needed for permission source)
          RULE_ARN="arn:aws:events:${{ env.AWS_REGION }}:918346807626:rule/${{ env.EVENTBRIDGE_RULE_NAME }}"

          # 1. Create/Update the EventBridge Rule (put-rule is idempotent)
          echo "Creating/Updating EventBridge rule: ${{ env.EVENTBRIDGE_RULE_NAME }}"
          aws events put-rule \
            --name "${{ env.EVENTBRIDGE_RULE_NAME }}" \
            --schedule-expression "${{ env.SCHEDULE_CRON }}" \
            --state ENABLED \
            --region "${{ env.AWS_REGION }}"

          # 2. Check if Lambda permission already exists using grep exit status
          echo "Checking for existing Lambda permission with Sid: ${STATEMENT_ID}"
          # Try to get the policy and grep for the Sid. Redirect errors to null.
          aws lambda get-policy --function-name "${{ env.LAMBDA_FUNCTION_NAME }}" --region "${{ env.AWS_REGION }}" 2>/dev/null | grep -q "\"Sid\":\"${STATEMENT_ID}\""
          GREP_EXIT_STATUS=$? # Capture grep's exit status (0 = found, 1 = not found)

          if [ $GREP_EXIT_STATUS -ne 0 ]; then
            # If grep failed (exit status != 0), the Sid was not found. Add permission.
            echo "Permission with Statement ID ${STATEMENT_ID} not found or get-policy failed. Adding permission..."
            aws lambda add-permission \
              --function-name "${{ env.LAMBDA_FUNCTION_NAME }}" \
              --statement-id "${STATEMENT_ID}" \
              --action "lambda:InvokeFunction" \
              --principal events.amazonaws.com \
              --source-arn "${RULE_ARN}" \
              --region "${{ env.AWS_REGION }}"
          else
            # If grep succeeded (exit status == 0), the Sid was found. Skip.
            echo "Permission with Statement ID ${STATEMENT_ID} already exists. Skipping add-permission."
          fi

          # 3. Set the Lambda Function as the Target of the Rule (put-targets is idempotent)
          echo "Setting Lambda function as target for rule: ${{ env.EVENTBRIDGE_RULE_NAME }}"
          aws events put-targets \
            --rule "${{ env.EVENTBRIDGE_RULE_NAME }}" \
            --targets "Id=1,Arn=${LAMBDA_ARN}" \
            --region "${{ env.AWS_REGION }}"

          echo "EventBridge schedule configured successfully."